// script.js
import * as THREE from 'three';
import { setupMotion } from './motion.js';
import { initializeSliders } from './sliders.js';
import { EffectComposer } from 'https://unpkg.com/three@0.162.0/examples/jsm/postprocessing/EffectComposer';
import { RenderPass } from 'https://unpkg.com/three@0.162.0/examples/jsm/postprocessing/RenderPass';
import { ShaderPass } from 'https://unpkg.com/three@0.162.0/examples/jsm/postprocessing/ShaderPass';

let currentSlide = 0;
const slides = [
    { title: "Slide 1", body: "This is the first slide.", objects: ['cube', 'pyramid'] },
    { title: "Slide 2", body: "This is the second slide.", objects: ['pyramid'] },
    { title: "Slide 3", body: "This is the third slide.", objects: ['pyramid', 'cylinder'] }
];

const objects = {
    cube: null,
    pyramid: null,
    cylinder: null
};

const environments = {
    complementCloud: {motionComponents: {momentum: false}},
    colorMatching: {},
    visualSpectrum: {}
}

function getPath(fileName) {
    const host = window.location.hostname;
    const isGitHub = host.includes('github.io');

    console.log(host);
    console.log(isGitHub);

    if (isGitHub) {
        console.log(`/color-matching/${fileName}`);
        return `../color-matching/${fileName}`;
    } else {
        return `../${fileName}`;
    }
}

async function loadShader(url) {
    const response = await fetch(getPath(url));
    if (!response.ok) {
        throw new Error(`Failed to load shader: ${url}`);
    }
    return response.text();
}

async function initEnvironment(environment, canvasElement, container) {

    // Add canvas
    environment.canvas = canvasElement;

    // Create scene
    environment.scene = new THREE.Scene();
    
    // Create camera
    environment.camera = new THREE.OrthographicCamera( 2 / - 2, 2 / 2, 2 / 2, 2 / - 2, 0, 1000 );
    environment.camera.position.set(0, 0, 0);
    environment.camera.zoom = 2;
    environment.camera.updateProjectionMatrix();

    // Create renderer
    environment.renderer = new THREE.WebGLRenderer({
        canvas: canvasElement,
        alpha: true, premultipliedAlpha: true,
        antialias: true});
    //THREE.ColorManagement.workingColorSpace = THREE.LinearDisplayP3ColorSpace; // I think this isn't necessary
    environment.renderer.outputColorSpace = THREE.DisplayP3ColorSpace

    // Resize
    var rect = container.getBoundingClientRect();
    environment.canvas.style.top = `${rect.top}px`;
    environment.canvas.style.left = `${rect.left}px`;
    environment.renderer.setSize(rect.width, rect.height);

    window.addEventListener('resize', () => {
        rect = container.getBoundingClientRect();
        environment.canvas.style.top = `${rect.top}px`;
        environment.canvas.style.left = `${rect.left}px`;
        environment.renderer.setSize(rect.width, rect.height);
    });
}

async function addObjects(environment) {

    // XYZ coordinates of complement spectrum
    const lookupTable = [0.203955,0.022454,0.999443,
        0.200203,0.021067,0.999448,
        0.196519,0.019508,0.999452,
        0.192520,0.019436,0.999461,
        0.188763,0.020809,0.999472,
        0.185450,0.023051,0.999484,
        0.182305,0.025523,0.999496,
        0.179486,0.028360,0.999508,
        0.176882,0.031397,0.999519,
        0.174569,0.034660,0.999530,
        0.172577,0.038129,0.999541,
        0.170705,0.041664,0.999551,
        0.168825,0.045194,0.999562,
        0.166926,0.048715,0.999572,
        0.165055,0.052250,0.999581,
        0.163252,0.055821,0.999591,
        0.161541,0.059436,0.999600,
        0.159912,0.063090,0.999609,
        0.158347,0.066771,0.999618,
        0.156829,0.070472,0.999626,
        0.155344,0.074186,0.999635,
        0.153883,0.077909,0.999643,
        0.152444,0.081641,0.999651,
        0.151028,0.085382,0.999659,
        0.149636,0.089132,0.999666,
        0.148268,0.092891,0.999674,
        0.146923,0.096658,0.999681,
        0.145603,0.100434,0.999688,
        0.144307,0.104219,0.999695,
        0.143035,0.108011,0.999701,
        0.141786,0.111811,0.999708,
        0.140557,0.115617,0.999714,
        0.139348,0.119430,0.999721,
        0.138157,0.123249,0.999727,
        0.136983,0.127073,0.999733,
        0.135826,0.130902,0.999739,
        0.134683,0.134735,0.999744,
        0.133554,0.138572,0.999750,
        0.132440,0.142414,0.999755,
        0.131337,0.146259,0.999761,
        0.130247,0.150107,0.999766,
        0.129168,0.153959,0.999771,
        0.128100,0.157814,0.999776,
        0.127042,0.161671,0.999781,
        0.125994,0.165532,0.999786,
        0.124957,0.169395,0.999791,
        0.123929,0.173261,0.999796,
        0.122911,0.177129,0.999800,
        0.121901,0.180999,0.999805,
        0.120901,0.184872,0.999809,
        0.119910,0.188748,0.999814,
        0.118927,0.192625,0.999818,
        0.117953,0.196505,0.999822,
        0.116987,0.200386,0.999826,
        0.116029,0.204270,0.999830,
        0.115079,0.208155,0.999834,
        0.114136,0.212043,0.999838,
        0.113201,0.215932,0.999842,
        0.112274,0.219823,0.999846,
        0.111354,0.223716,0.999849,
        0.110441,0.227610,0.999853,
        0.109535,0.231506,0.999857,
        0.108636,0.235404,0.999860,
        0.107743,0.239303,0.999864,
        0.106858,0.243204,0.999867,
        0.105979,0.247106,0.999870,
        0.105106,0.251009,0.999874,
        0.104240,0.254915,0.999877,
        0.103380,0.258821,0.999880,
        0.102527,0.262729,0.999883,
        0.101680,0.266638,0.999886,
        0.100839,0.270549,0.999889,
        0.100004,0.274461,0.999892,
        0.099176,0.278374,0.999895,
        0.098353,0.282289,0.999898,
        0.097537,0.286204,0.999901,
        0.096726,0.290121,0.999904,
        0.095922,0.294040,0.999906,
        0.095123,0.297959,0.999909,
        0.094330,0.301880,0.999912,
        0.093543,0.305802,0.999914,
        0.092762,0.309724,0.999917,
        0.091986,0.313649,0.999919,
        0.091216,0.317574,0.999921,
        0.090451,0.321500,0.999924,
        0.089693,0.325427,0.999926,
        0.088939,0.329356,0.999928,
        0.088191,0.333285,0.999930,
        0.087449,0.337216,0.999932,
        0.086712,0.341147,0.999934,
        0.085980,0.345080,0.999936,
        0.085254,0.349013,0.999938,
        0.084533,0.352948,0.999940,
        0.083817,0.356883,0.999942,
        0.083106,0.360819,0.999944,
        0.082401,0.364757,0.999945,
        0.081700,0.368695,0.999947,
        0.081005,0.372634,0.999949,
        0.080315,0.376574,0.999950,
        0.079630,0.380515,0.999952,
        0.078949,0.384457,0.999953,
        0.078274,0.388399,0.999955,
        0.077604,0.392343,0.999956,
        0.076938,0.396287,0.999958,
        0.076278,0.400232,0.999959,
        0.075622,0.404178,0.999960,
        0.074971,0.408124,0.999962,
        0.074324,0.412072,0.999963,
        0.073682,0.416020,0.999964,
        0.073045,0.419969,0.999965,
        0.072413,0.423919,0.999967,
        0.071785,0.427869,0.999968,
        0.071162,0.431820,0.999969,
        0.070543,0.435772,0.999970,
        0.069929,0.439725,0.999971,
        0.069319,0.443678,0.999972,
        0.068714,0.447632,0.999973,
        0.068113,0.451586,0.999974,
        0.067516,0.455542,0.999975,
        0.066924,0.459498,0.999976,
        0.066336,0.463454,0.999977,
        0.065753,0.467411,0.999978,
        0.065174,0.471369,0.999978,
        0.064599,0.475328,0.999979,
        0.064028,0.479287,0.999980,
        0.063461,0.483246,0.999981,
        0.062899,0.487207,0.999982,
        0.062341,0.491168,0.999982,
        0.061787,0.495129,0.999983,
        0.061237,0.499091,0.999984,
        0.060691,0.503054,0.999984,
        0.060149,0.507017,0.999985,
        0.059611,0.510980,0.999986,
        0.059077,0.514945,0.999986,
        0.058549,0.518900,0.999987,
        0.058023,0.522866,0.999988,
        0.057502,0.526831,0.999988,
        0.056983,0.530798,0.999989,
        0.056469,0.534764,0.999989,
        0.055959,0.538732,0.999990,
        0.055454,0.542700,0.999997,
        0.054952,0.546668,1.000000,
        0.054453,0.550637,1.000000,
        0.053958,0.554606,1.000000,
        0.053467,0.558576,1.000000,
        0.052980,0.562546,1.000000,
        0.052497,0.566517,1.000000,
        0.052016,0.570488,1.000000,
        0.051540,0.574460,1.000000,
        0.051068,0.578432,1.000000,
        0.050600,0.582404,1.000000,
        0.050134,0.586377,1.000000,
        0.049702,0.590104,1.000000,
        0.049244,0.594078,1.000000,
        0.048790,0.598052,1.000000,
        0.048338,0.602026,1.000000,
        0.047892,0.606001,1.000000,
        0.047448,0.609977,1.000000,
        0.047008,0.613952,1.000000,
        0.046571,0.617928,1.000000,
        0.046139,0.621905,1.000000,
        0.045709,0.625882,1.000000,
        0.045328,0.629439,1.000000,
        0.044767,0.633013,0.998383,
        0.044231,0.634630,0.995110,
        0.043784,0.634680,0.991135,
        0.043338,0.634730,0.987160,
        0.042894,0.634781,0.983185,
        0.042451,0.634833,0.979210,
        0.042055,0.634880,0.975639,
        0.041614,0.634932,0.971664,
        0.041176,0.634986,0.967688,
        0.040739,0.635040,0.963712,
        0.040303,0.635094,0.959737,
        0.039869,0.635149,0.955761,
        0.039436,0.635205,0.951784,
        0.039212,0.635234,0.949712,
        0.038781,0.635290,0.945735,
        0.038353,0.635348,0.941759,
        0.037926,0.635405,0.937782,
        0.037501,0.635464,0.933805,
        0.037077,0.635523,0.929828,
        0.036655,0.635583,0.925851,
        0.036235,0.635643,0.921873,
        0.035816,0.635704,0.917896,
        0.035399,0.635766,0.913918,
        0.034983,0.635828,0.909940,
        0.034570,0.635891,0.905962,
        0.034158,0.635954,0.901984,
        0.033748,0.636019,0.898006,
        0.033340,0.636084,0.894027,
        0.032934,0.636150,0.890048,
        0.032529,0.636216,0.886069,
        0.032126,0.636283,0.882090,
        0.031725,0.636351,0.878111,
        0.031326,0.636420,0.874131,
        0.030929,0.636489,0.870152,
        0.030534,0.636559,0.866172,
        0.030141,0.636630,0.862192,
        0.029750,0.636702,0.858212,
        0.029361,0.636774,0.854231,
        0.028973,0.636847,0.850251,
        0.028588,0.636922,0.846270,
        0.028205,0.636996,0.842289,
        0.027824,0.637072,0.838308,
        0.027445,0.637148,0.834327,
        0.027069,0.637226,0.830345,
        0.026694,0.637303,0.826364,
        0.026322,0.637383,0.822382,
        0.025951,0.637462,0.818400,
        0.025584,0.637543,0.814418,
        0.025218,0.637625,0.810435,
        0.024855,0.637707,0.806453,
        0.024494,0.637791,0.802470,
        0.024135,0.637875,0.798487,
        0.023779,0.637960,0.794504,
        0.023425,0.638046,0.790520,
        0.023074,0.638133,0.786537,
        0.022725,0.638221,0.782553,
        0.022379,0.638310,0.778569,
        0.022035,0.638400,0.774585,
        0.021693,0.638491,0.770600,
        0.021355,0.638583,0.766616,
        0.021018,0.638676,0.762631,
        0.020685,0.638770,0.758646,
        0.020354,0.638865,0.754661,
        0.020026,0.638961,0.750675,
        0.019701,0.639059,0.746690,
        0.019378,0.639157,0.742704,
        0.019059,0.639256,0.738718,
        0.018742,0.639357,0.734732,
        0.018429,0.639458,0.730746,
        0.018118,0.639561,0.726759,
        0.017809,0.639665,0.722772,
        0.017505,0.639770,0.718785,
        0.017203,0.639876,0.714798,
        0.016904,0.639984,0.710811,
        0.016610,0.640093,0.706823,
        0.016317,0.640202,0.702835,
        0.016028,0.640313,0.698847,
        0.015742,0.640426,0.694859,
        0.015459,0.640540,0.690871,
        0.015181,0.640655,0.686882,
        0.014905,0.640771,0.682893,
        0.014632,0.640888,0.678904,
        0.014364,0.641007,0.674915,
        0.014098,0.641128,0.670926,
        0.013835,0.641249,0.666936,
        0.013577,0.641372,0.662947,
        0.013321,0.641496,0.658957,
        0.013069,0.641621,0.654967,
        0.012843,0.641736,0.651346,
        0.012598,0.641864,0.647356,
        0.012356,0.641994,0.643365,
        0.012139,0.642112,0.639735,
        0.011904,0.642244,0.635744,
        0.011671,0.642377,0.631753,
        0.011442,0.642512,0.627761,
        0.011218,0.642648,0.623770,
        0.010996,0.642785,0.619779,
        0.010778,0.642923,0.615787,
        0.010563,0.643063,0.611795,
        0.010353,0.643205,0.607803,
        0.010145,0.643347,0.603811,
        0.009940,0.643491,0.599819,
        0.009740,0.643636,0.595827,
        0.009543,0.643783,0.591834,
        0.009349,0.643931,0.587842,
        0.009159,0.644080,0.583849,
        0.008972,0.644231,0.579856,
        0.008790,0.644383,0.575863,
        0.008610,0.644536,0.571870,
        0.008433,0.644690,0.567877,
        0.008266,0.644841,0.564007,
        0.008097,0.644999,0.560013,
        0.007931,0.645157,0.556020,
        0.007768,0.645317,0.552027,
        0.007609,0.645478,0.548033,
        0.007453,0.645641,0.544039,
        0.007301,0.645805,0.540046,
        0.007152,0.645970,0.536052,
        0.007006,0.646136,0.532058,
        0.006864,0.646304,0.528064,
        0.006725,0.646473,0.524070,
        0.006589,0.646643,0.520076,
        0.006457,0.646814,0.516082,
        0.006328,0.646987,0.512088,
        0.006202,0.647161,0.508093,
        0.006080,0.647336,0.504099,
        0.005960,0.647513,0.500105,
        0.005844,0.647690,0.496110,
        0.005731,0.647869,0.492116,
        0.005621,0.648049,0.488121,
        0.005514,0.648230,0.484127,
        0.005410,0.648413,0.480133,
        0.005309,0.648596,0.476138,
        0.005211,0.648781,0.472143,
        0.005116,0.648967,0.468149,
        0.005024,0.649154,0.464154,
        0.004935,0.649342,0.460160,
        0.004849,0.649531,0.456165,
        0.004765,0.649721,0.452171,
        0.004684,0.649912,0.448176,
        0.004606,0.650104,0.444181,
        0.004530,0.650297,0.440187,
        0.004458,0.650492,0.436192,
        0.004387,0.650687,0.432197,
        0.004320,0.650883,0.428203,
        0.004256,0.651081,0.424208,
        0.004195,0.651279,0.420214,
        0.004137,0.651479,0.416219,
        0.004082,0.651680,0.412225,
        0.004030,0.651883,0.408230,
        0.003982,0.652087,0.404235,
        0.003938,0.652292,0.400241,
        0.003897,0.652498,0.396247,
        0.003860,0.652706,0.392252,
        0.003827,0.652916,0.388258,
        0.003798,0.653127,0.384263,
        0.003773,0.653339,0.380269,
        0.003752,0.653553,0.376275,
        0.003736,0.653769,0.372281,
        0.003724,0.653987,0.368287,
        0.003718,0.654206,0.364293,
        0.003716,0.654428,0.360299,
        0.003719,0.654651,0.356305,
        0.003728,0.654876,0.352312,
        0.003742,0.655104,0.348318,
        0.003761,0.655333,0.344325,
        0.003787,0.655565,0.340331,
        0.003818,0.655799,0.336338,
        0.003855,0.656035,0.332346,
        0.003899,0.656274,0.328353,
        0.003950,0.656515,0.324361,
        0.004007,0.656759,0.320368,
        0.004071,0.657006,0.316377,
        0.004142,0.657255,0.312385,
        0.004222,0.657507,0.308394,
        0.004309,0.657763,0.304403,
        0.004405,0.658021,0.300412,
        0.004508,0.658283,0.296422,
        0.004621,0.658547,0.292433,
        0.004743,0.658816,0.288443,
        0.004874,0.659088,0.284455,
        0.005014,0.659363,0.280467,
        0.005166,0.659643,0.276479,
        0.005327,0.659926,0.272493,
        0.005499,0.660214,0.268507,
        0.005684,0.660506,0.264522,
        0.005879,0.660802,0.260538,
        0.006088,0.661104,0.256554,
        0.006310,0.661410,0.252572,
        0.006545,0.661721,0.248591,
        0.006796,0.662038,0.244612,
        0.007061,0.662361,0.240634,
        0.007344,0.662691,0.236657,
        0.007644,0.663026,0.232683,
        0.007962,0.663369,0.228710,
        0.008299,0.663719,0.224740,
        0.008659,0.664077,0.220772,
        0.009038,0.664442,0.216807,
        0.009442,0.664817,0.212845,
        0.009870,0.665201,0.208887,
        0.010323,0.665594,0.204932,
        0.010804,0.665998,0.200982,
        0.011315,0.666413,0.197036,
        0.011856,0.666839,0.193096,
        0.012430,0.667277,0.189162,
        0.013039,0.667729,0.185234,
        0.013687,0.668194,0.181314,
        0.014374,0.668675,0.177403,
        0.015104,0.669171,0.173502,
        0.015880,0.669684,0.169612,
        0.016705,0.670215,0.165734,
        0.017582,0.670766,0.161870,
        0.018516,0.671337,0.158023,
        0.019510,0.671930,0.154194,
        0.020567,0.672546,0.150386,
        0.021695,0.673188,0.146602,
        0.022889,0.673854,0.142843,
        0.024154,0.674545,0.139112,
        0.025486,0.675261,0.135409,
        0.026891,0.676002,0.131737,
        0.028363,0.676768,0.128098,
        0.029903,0.677557,0.124492,
        0.031509,0.678371,0.120920,
        0.033180,0.679207,0.117383,
        0.034914,0.680065,0.113882,
        0.036708,0.680944,0.110417,
        0.038558,0.681842,0.106986,
        0.040462,0.682759,0.103589,
        0.042414,0.683693,0.100225,
        0.044412,0.684643,0.096893,
        0.046451,0.685606,0.093589,
        0.048525,0.686582,0.090311,
        0.050635,0.687570,0.087060,
        0.052786,0.688572,0.083839,
        0.054982,0.689589,0.080655,
        0.057232,0.690625,0.077514,
        0.059540,0.691680,0.074422,
        0.061913,0.692756,0.071387,
        0.064357,0.693856,0.068418,
        0.066877,0.694981,0.065522,
        0.069479,0.696133,0.062711,
        0.072166,0.697312,0.059992,
        0.074940,0.698519,0.057376,
        0.077804,0.699754,0.054871,
        0.080754,0.701015,0.052482,
        0.083782,0.702300,0.050207,
        0.086882,0.703606,0.048042,
        0.090044,0.704931,0.045982,
        0.093263,0.706271,0.044021,
        0.096530,0.707625,0.042153,
        0.099842,0.708991,0.040374,
        0.103193,0.710367,0.038676,
        0.106578,0.711752,0.037057,
        0.109993,0.713145,0.035509,
        0.113436,0.714544,0.034029,
        0.116902,0.715949,0.032612,
        0.120391,0.717359,0.031255,
        0.123900,0.718774,0.029956,
        0.127427,0.720192,0.028713,
        0.130972,0.721614,0.027523,
        0.134532,0.723040,0.026385,
        0.138106,0.724467,0.025296,
        0.141693,0.725898,0.024254,
        0.145292,0.727330,0.023257,
        0.148902,0.728764,0.022303,
        0.152523,0.730200,0.021390,
        0.156152,0.731637,0.020517,
        0.159790,0.733075,0.019682,
        0.163435,0.734514,0.018883,
        0.167088,0.735954,0.018120,
        0.170748,0.737395,0.017392,
        0.174414,0.738836,0.016698,
        0.178086,0.740278,0.016036,
        0.181764,0.741719,0.015405,
        0.185446,0.743162,0.014804,
        0.189133,0.744604,0.014231,
        0.192824,0.746046,0.013686,
        0.196518,0.747488,0.013168,
        0.200217,0.748931,0.012674,
        0.203918,0.750373,0.012204,
        0.207622,0.751815,0.011756,
        0.211329,0.753256,0.011329,
        0.215037,0.754698,0.010922,
        0.218748,0.756139,0.010533,
        0.222461,0.757580,0.010161,
        0.226176,0.759021,0.009806,
        0.229892,0.760462,0.009467,
        0.233610,0.761902,0.009143,
        0.237329,0.763342,0.008832,
        0.241049,0.764782,0.008535,
        0.244770,0.766221,0.008251,
        0.248492,0.767660,0.007978,
        0.252215,0.769099,0.007717,
        0.255939,0.770538,0.007467,
        0.259664,0.771976,0.007227,
        0.263389,0.773414,0.006997,
        0.267115,0.774852,0.006777,
        0.270842,0.776289,0.006565,
        0.274570,0.777726,0.006362,
        0.278297,0.779163,0.006167,
        0.282026,0.780600,0.005980,
        0.285755,0.782037,0.005801,
        0.289484,0.783473,0.005628,
        0.293214,0.784909,0.005463,
        0.296944,0.786345,0.005304,
        0.300674,0.787780,0.005151,
        0.304405,0.789216,0.005003,
        0.308136,0.790651,0.004862,
        0.311867,0.792086,0.004726,
        0.315598,0.793521,0.004595,
        0.319330,0.794955,0.004469,
        0.323062,0.796390,0.004347,
        0.326794,0.797824,0.004229,
        0.330527,0.799258,0.004116,
        0.334259,0.800692,0.004007,
        0.337992,0.802126,0.003901,
        0.341725,0.803560,0.003799,
        0.345458,0.804993,0.003700,
        0.349191,0.806427,0.003604,
        0.352924,0.807860,0.003512,
        0.356657,0.809294,0.003422,
        0.360391,0.810727,0.003335,
        0.364124,0.812160,0.003251,
        0.367858,0.813593,0.003169,
        0.371592,0.815025,0.003090,
        0.375325,0.816458,0.003013,
        0.379059,0.817891,0.002938,
        0.382793,0.819323,0.002866,
        0.386527,0.820756,0.002796,
        0.390262,0.822188,0.002728,
        0.393996,0.823620,0.002663,
        0.397730,0.825052,0.002600,
        0.401464,0.826484,0.002539,
        0.405199,0.827916,0.002480,
        0.408933,0.829348,0.002423,
        0.412668,0.830780,0.002368,
        0.416403,0.832211,0.002315,
        0.420137,0.833643,0.002265,
        0.423872,0.835075,0.002215,
        0.427607,0.836506,0.002168,
        0.431342,0.837937,0.002123,
        0.435077,0.839369,0.002079,
        0.438812,0.840800,0.002036,
        0.442547,0.842231,0.001996,
        0.446282,0.843662,0.001956,
        0.450017,0.845093,0.001919,
        0.453752,0.846524,0.001882,
        0.457487,0.847955,0.001847,
        0.461222,0.849386,0.001813,
        0.464957,0.850816,0.001780,
        0.468693,0.852247,0.001748,
        0.472428,0.853678,0.001717,
        0.476163,0.855109,0.001687,
        0.479898,0.856539,0.001657,
        0.483634,0.857970,0.001629,
        0.487369,0.859400,0.001601,
        0.491104,0.860831,0.001574,
        0.494840,0.862261,0.001548,
        0.498575,0.863692,0.001522,
        0.502311,0.865122,0.001497,
        0.506046,0.866553,0.001473,
        0.509781,0.867983,0.001449,
        0.513517,0.869413,0.001426,
        0.517252,0.870844,0.001403,
        0.520988,0.872274,0.001380,
        0.524723,0.873704,0.001359,
        0.528459,0.875134,0.001337,
        0.532194,0.876565,0.001316,
        0.535930,0.877995,0.001295,
        0.539665,0.879425,0.001275,
        0.543401,0.880855,0.001255,
        0.547136,0.882285,0.001236,
        0.550872,0.883716,0.001217,
        0.554608,0.885146,0.001198,
        0.558343,0.886576,0.001179,
        0.562079,0.888006,0.001161,
        0.565814,0.889436,0.001143,
        0.569550,0.890866,0.001126,
        0.573285,0.892296,0.001109,
        0.577021,0.893726,0.001092,
        0.580757,0.895156,0.001076,
        0.584492,0.896586,0.001060,
        0.588228,0.898016,0.001045,
        0.591964,0.899446,0.001030,
        0.595699,0.900876,0.001015,
        0.599435,0.902306,0.001000,
        0.603171,0.903736,0.000986,
        0.606906,0.905166,0.000972,
        0.610642,0.906596,0.000958,
        0.614378,0.908026,0.000945,
        0.618113,0.909455,0.000932,
        0.621849,0.910885,0.000920,
        0.625585,0.912315,0.000907,
        0.629320,0.913745,0.000895,
        0.633056,0.915175,0.000884,
        0.636792,0.916604,0.000872,
        0.640527,0.918034,0.000861,
        0.644263,0.919464,0.000850,
        0.647999,0.920894,0.000840,
        0.651735,0.922323,0.000829,
        0.655470,0.923753,0.000819,
        0.659206,0.925183,0.000809,
        0.662942,0.926613,0.000800,
        0.666678,0.928042,0.000790,
        0.670413,0.929472,0.000781,
        0.674149,0.930902,0.000772,
        0.677885,0.932331,0.000763,
        0.681621,0.933761,0.000755,
        0.685357,0.935191,0.000746,
        0.689092,0.936620,0.000738,
        0.692828,0.938050,0.000730,
        0.696564,0.939479,0.000722,
        0.700300,0.940909,0.000714,
        0.704035,0.942339,0.000707,
        0.707771,0.943768,0.000699,
        0.711507,0.945198,0.000692,
        0.715243,0.946627,0.000685,
        0.718979,0.948057,0.000678,
        0.722715,0.949487,0.000671,
        0.726450,0.950916,0.000664,
        0.730186,0.952346,0.000658,
        0.733922,0.953775,0.000651,
        0.737658,0.955205,0.000645,
        0.741394,0.956634,0.000638,
        0.745129,0.958064,0.000632,
        0.748865,0.959493,0.000626,
        0.752601,0.960923,0.000620,
        0.756337,0.962352,0.000614,
        0.760073,0.963782,0.000608,
        0.763809,0.965211,0.000603,
        0.767544,0.966641,0.000597,
        0.771280,0.968070,0.000592,
        0.775016,0.969500,0.000586,
        0.778752,0.970929,0.000581,
        0.782488,0.972359,0.000576,
        0.786224,0.973788,0.000570,
        0.789960,0.975218,0.000565,
        0.793695,0.976647,0.000560,
        0.797579,0.977587,0.000554,
        0.801124,0.979417,0.000550,
        0.804900,0.980724,0.000545,
        0.808859,0.980166,0.000535,
        0.812467,0.978439,0.000524,
        0.815698,0.976081,0.000512,
        0.818738,0.973483,0.000500,
        0.821472,0.970562,0.000488,
        0.823989,0.967454,0.000477,
        0.826171,0.964102,0.000466,
        0.828102,0.960599,0.000455,
        0.829969,0.957061,0.000445,
        0.831860,0.953537,0.000435,
        0.833754,0.950013,0.000425,
        0.835603,0.946466,0.000415,
        0.837373,0.942880,0.000406,
        0.839053,0.939249,0.000397,
        0.840657,0.935585,0.000388,
        0.842204,0.931896,0.000379,
        0.843709,0.928190,0.000371,
        0.845186,0.924473,0.000362,
        0.846639,0.920746,0.000354,
        0.848069,0.917010,0.000346,
        0.849476,0.913266,0.000339,
        0.850860,0.909513,0.000331,
        0.852219,0.905751,0.000324,
        0.853555,0.901981,0.000317,
        0.854866,0.898202,0.000310,
        0.856154,0.894415,0.000303,
        0.857418,0.890620,0.000296,
        0.858659,0.886817,0.000290,
        0.859880,0.883008,0.000283,
        0.861083,0.879193,0.000277,
        0.862268,0.875373,0.000271,
        0.863435,0.871547,0.000265,
        0.864588,0.867717,0.000259,
        0.865725,0.863882,0.000254,
        0.866849,0.860043,0.000248,
        0.867959,0.856200,0.000243,
        0.869057,0.852354,0.000237,
        0.870143,0.848504,0.000232,
        0.871218,0.844651,0.000227,
        0.872283,0.840795,0.000222,
        0.873337,0.836937,0.000217,
        0.874381,0.833075,0.000212,
        0.875415,0.829211,0.000207,
        0.876439,0.825345,0.000203,
        0.877454,0.821476,0.000198,
        0.878460,0.817604,0.000194,
        0.879457,0.813731,0.000189,
        0.880445,0.809855,0.000185,
        0.881425,0.805976,0.000181,
        0.882396,0.802096,0.000177,
        0.883360,0.798214,0.000172,
        0.884315,0.794330,0.000168,
        0.885262,0.790443,0.000164,
        0.886202,0.786555,0.000161,
        0.887134,0.782665,0.000157,
        0.888059,0.778774,0.000153,
        0.888976,0.774880,0.000149,
        0.889886,0.770985,0.000146,
        0.890790,0.767089,0.000142,
        0.891687,0.763191,0.000139,
        0.892577,0.759291,0.000135,
        0.893460,0.755390,0.000132,
        0.894337,0.751487,0.000128,
        0.895207,0.747583,0.000125,
        0.896071,0.743677,0.000122,
        0.896928,0.739770,0.000119,
        0.897779,0.735862,0.000116,
        0.898624,0.731952,0.000113,
        0.899463,0.728041,0.000110,
        0.900295,0.724128,0.000107,
        0.901121,0.720215,0.000104,
        0.901942,0.716300,0.000101,
        0.902756,0.712383,0.000098,
        0.903564,0.708466,0.000095,
        0.904367,0.704547,0.000093,
        0.905163,0.700627,0.000090,
        0.905954,0.696706,0.000087,
        0.906739,0.692784,0.000085,
        0.907518,0.688861,0.000082,
        0.908292,0.684936,0.000080,
        0.909060,0.681011,0.000078,
        0.909823,0.677084,0.000075,
        0.910580,0.673156,0.000073,
        0.911331,0.669227,0.000071,
        0.912077,0.665298,0.000069,
        0.912817,0.661367,0.000067,
        0.913552,0.657435,0.000065,
        0.914282,0.653502,0.000063,
        0.915007,0.649568,0.000061,
        0.915726,0.645633,0.000059,
        0.916440,0.641698,0.000058,
        0.917149,0.637761,0.000056,
        0.917852,0.633823,0.000054,
        0.918551,0.629885,0.000052,
        0.919244,0.625945,0.000051,
        0.919933,0.622005,0.000049,
        0.920616,0.618064,0.000048,
        0.921295,0.614122,0.000046,
        0.921968,0.610179,0.000045,
        0.922637,0.606235,0.000043,
        0.923301,0.602291,0.000042,
        0.923960,0.598345,0.000040,
        0.924614,0.594399,0.000039,
        0.925263,0.590452,0.000038,
        0.925908,0.586505,0.000037,
        0.926548,0.582556,0.000035,
        0.927183,0.578607,0.000034,
        0.927814,0.574657,0.000033,
        0.928440,0.570706,0.000032,
        0.929062,0.566755,0.000031,
        0.929679,0.562803,0.000030,
        0.930292,0.558850,0.000029,
        0.930900,0.554896,0.000028,
        0.931504,0.550942,0.000027,
        0.932103,0.546987,0.000026,
        0.932698,0.543032,0.000025,
        0.933289,0.539076,0.000024,
        0.933875,0.535119,0.000023,
        0.934457,0.531161,0.000022,
        0.935034,0.527203,0.000021,
        0.935608,0.523245,0.000020,
        0.936177,0.519285,0.000020,
        0.936742,0.515326,0.000019,
        0.937303,0.511365,0.000018,
        0.937860,0.507404,0.000017,
        0.938412,0.503442,0.000017,
        0.938961,0.499480,0.000016,
        0.939505,0.495517,0.000015,
        0.940045,0.491554,0.000015,
        0.940581,0.487590,0.000014,
        0.941114,0.483626,0.000013,
        0.941642,0.479661,0.000013,
        0.942167,0.475695,0.000012,
        0.942687,0.471729,0.000012,
        0.943203,0.467763,0.000011,
        0.943716,0.463796,0.000010,
        0.944225,0.459828,0.000010,
        0.944729,0.455860,-0.000000,
        0.945230,0.451892,0.000000,
        0.945727,0.447923,-0.000000,
        0.946220,0.443953,0.000000,
        0.946710,0.439983,-0.000000,
        0.947196,0.436013,-0.000000,
        0.947678,0.432042,0.000000,
        0.948156,0.428071,0.000000,
        0.948631,0.424099,-0.000000,
        0.949103,0.420127,0.000000,
        0.949569,0.416154,0.000000,
        0.950033,0.412181,-0.000000,
        0.950493,0.408208,-0.000000,
        0.950950,0.404234,-0.000000,
        0.951402,0.400260,-0.000000,
        0.951851,0.396285,0.000000,
        0.952298,0.392310,0.000000,
        0.952739,0.388334,0.000000,
        0.953178,0.384358,-0.000000,
        0.953613,0.380382,-0.000000,
        0.954044,0.376405,0.000000,
        0.954472,0.372428,-0.000000,
        0.954897,0.368451,0.000000,
        0.955496,0.365400,0.002464,
        0.955943,0.365351,0.006438,
        0.956390,0.365301,0.010413,
        0.956835,0.365250,0.014388,
        0.957279,0.365199,0.018363,
        0.957721,0.365147,0.022338,
        0.958162,0.365094,0.026313,
        0.958601,0.365041,0.030288,
        0.959039,0.364988,0.034264,
        0.959476,0.364934,0.038240,
        0.959910,0.364879,0.042216,
        0.960344,0.364824,0.046192,
        0.960775,0.364768,0.050168,
        0.961206,0.364711,0.054144,
        0.961634,0.364654,0.058121,
        0.962061,0.364596,0.062098,
        0.962486,0.364538,0.066075,
        0.962910,0.364479,0.070052,
        0.963332,0.364419,0.074029,
        0.963753,0.364359,0.078006,
        0.964172,0.364298,0.081984,
        0.964589,0.364236,0.085962,
        0.965004,0.364174,0.089939,
        0.965417,0.364111,0.093918,
        0.965830,0.364048,0.097896,
        0.966239,0.363983,0.101874,
        0.966648,0.363918,0.105853,
        0.967054,0.363852,0.109832,
        0.967459,0.363786,0.113810,
        0.967862,0.363719,0.117790,
        0.968263,0.363651,0.121769,
        0.968662,0.363582,0.125748,
        0.969059,0.363513,0.129728,
        0.969454,0.363443,0.133708,
        0.969847,0.363372,0.137688,
        0.970238,0.363300,0.141668,
        0.970628,0.363228,0.145648,
        0.971015,0.363155,0.149629,
        0.971400,0.363081,0.153609,
        0.971783,0.363006,0.157590,
        0.972164,0.362930,0.161572,
        0.972543,0.362854,0.165553,
        0.972920,0.362777,0.169534,
        0.973295,0.362699,0.173516,
        0.973667,0.362620,0.177498,
        0.974038,0.362540,0.181480,
        0.974405,0.362459,0.185462,
        0.974771,0.362378,0.189444,
        0.975134,0.362295,0.193427,
        0.975495,0.362212,0.197410,
        0.975854,0.362128,0.201393,
        0.976210,0.362042,0.205376,
        0.976564,0.361957,0.209359,
        0.976915,0.361869,0.213343,
        0.977264,0.361781,0.217327,
        0.977611,0.361692,0.221311,
        0.977955,0.361603,0.225295,
        0.978296,0.361512,0.229279,
        0.978635,0.361420,0.233264,
        0.978972,0.361327,0.237249,
        0.979305,0.361233,0.241234,
        0.979635,0.361138,0.245219,
        0.979964,0.361042,0.249204,
        0.980289,0.360944,0.253190,
        0.980611,0.360846,0.257175,
        0.980931,0.360747,0.261161,
        0.981248,0.360646,0.265148,
        0.981562,0.360545,0.269134,
        0.981873,0.360442,0.273120,
        0.982181,0.360338,0.277107,
        0.982486,0.360233,0.281094,
        0.982788,0.360127,0.285081,
        0.983086,0.360019,0.289069,
        0.983382,0.359911,0.293056,
        0.983674,0.359801,0.297044,
        0.983963,0.359690,0.301032,
        0.984249,0.359577,0.305020,
        0.984531,0.359464,0.309009,
        0.984811,0.359349,0.312997,
        0.985086,0.359232,0.316986,
        0.985360,0.359115,0.320975,
        0.985628,0.358996,0.324964,
        0.985894,0.358876,0.328954,
        0.986156,0.358754,0.332943,
        0.986415,0.358632,0.336933,
        0.986671,0.358508,0.340923,
        0.986923,0.358382,0.344913,
        0.987172,0.358256,0.348903,
        0.987417,0.358127,0.352894,
        0.987659,0.357998,0.356884,
        0.987897,0.357867,0.360875,
        0.988132,0.357735,0.364866,
        0.988363,0.357602,0.368857,
        0.988592,0.357467,0.372848,
        0.988816,0.357331,0.376839,
        0.989037,0.357194,0.380831,
        0.989255,0.357055,0.384823,
        0.989469,0.356915,0.388814,
        0.989679,0.356774,0.392806,
        0.989886,0.356631,0.396798,
        0.990090,0.356487,0.400791,
        0.990290,0.356341,0.404783,
        0.990487,0.356195,0.408776,
        0.990680,0.356046,0.412768,
        0.990869,0.355897,0.416761,
        0.991055,0.355746,0.420754,
        0.991238,0.355594,0.424747,
        0.991417,0.355441,0.428740,
        0.991593,0.355286,0.432733,
        0.991765,0.355130,0.436726,
        0.991934,0.354972,0.440719,
        0.992099,0.354813,0.444713,
        0.992261,0.354653,0.448706,
        0.992420,0.354492,0.452700,
        0.992575,0.354329,0.456693,
        0.992727,0.354165,0.460687,
        0.992875,0.354000,0.464681,
        0.993020,0.353833,0.468675,
        0.993162,0.353665,0.472669,
        0.993300,0.353496,0.476663,
        0.993435,0.353326,0.480657,
        0.993567,0.353154,0.484651,
        0.993695,0.352981,0.488645,
        0.993820,0.352807,0.492640,
        0.993942,0.352631,0.496634,
        0.994061,0.352455,0.500628,
        0.994177,0.352277,0.504623,
        0.994289,0.352098,0.508617,
        0.994399,0.351918,0.512611,
        0.994505,0.351736,0.516606,
        0.994609,0.351554,0.520600,
        0.994709,0.351370,0.524595,
        0.994806,0.351185,0.528589,
        0.994901,0.350999,0.532584,
        0.994992,0.350812,0.536579,
        0.995081,0.350624,0.540573,
        0.995167,0.350434,0.544568,
        0.995250,0.350244,0.548562,
        0.995330,0.350053,0.552557,
        0.995408,0.349861,0.556552,
        0.995483,0.349667,0.560546,
        0.995556,0.349473,0.564541,
        0.995625,0.349277,0.568535,
        0.995692,0.349081,0.572530,
        0.995755,0.348883,0.576525,
        0.995816,0.348684,0.580519,
        0.995873,0.348484,0.584514,
        0.995927,0.348282,0.588508,
        0.995978,0.348080,0.592503,
        0.996026,0.347876,0.596497,
        0.996070,0.347671,0.600492,
        0.996110,0.347464,0.604486,
        0.996146,0.347255,0.608481,
        0.996178,0.347046,0.612475,
        0.996206,0.346834,0.616470,
        0.996230,0.346621,0.620464,
        0.996250,0.346407,0.624458,
        0.996266,0.346191,0.628452,
        0.996277,0.345973,0.632446,
        0.996282,0.345754,0.636416,
        0.996283,0.345532,0.640409,
        0.996279,0.345309,0.644403,
        0.996269,0.345083,0.648397,
        0.996254,0.344855,0.652390,
        0.996234,0.344626,0.656384,
        0.996209,0.344395,0.660358,
        0.996176,0.344160,0.664351,
        0.996137,0.343923,0.668343,
        0.996092,0.343684,0.672336,
        0.996040,0.343442,0.676328,
        0.995982,0.343198,0.680320,
        0.995917,0.342951,0.684312,
        0.995843,0.342701,0.688304,
        0.995762,0.342448,0.692295,
        0.995673,0.342192,0.696286,
        0.995577,0.341934,0.700276,
        0.995472,0.341672,0.704266,
        0.995358,0.341406,0.708256,
        0.995235,0.341137,0.712245,
        0.995101,0.340864,0.716233,
        0.994958,0.340588,0.720221,
        0.994806,0.340308,0.724208,
        0.994644,0.340024,0.728195,
        0.994468,0.339735,0.732181,
        0.994282,0.339442,0.736166,
        0.994083,0.339145,0.740150,
        0.993873,0.338843,0.744133,
        0.993650,0.338536,0.748115,
        0.993412,0.338224,0.752095,
        0.993157,0.337905,0.756074,
        0.992888,0.337581,0.760052,
        0.992603,0.337251,0.764028,
        0.992301,0.336915,0.768003,
        0.991980,0.336571,0.771975,
        0.991637,0.336219,0.775945,
        0.991273,0.335859,0.779912,
        0.990889,0.335492,0.783876,
        0.990484,0.335116,0.787838,
        0.990053,0.334732,0.791796,
        0.989592,0.334336,0.795750,
        0.989105,0.333929,0.799699,
        0.988589,0.333513,0.803644,
        0.988043,0.333085,0.807583,
        0.987466,0.332645,0.811517,
        0.986847,0.332190,0.815442,
        0.986190,0.331721,0.819360,
        0.985494,0.331238,0.823269,
        0.984758,0.330739,0.827169,
        0.983978,0.330224,0.831058,
        0.983162,0.329702,0.834849,
        0.982272,0.329147,0.838709,
        0.981328,0.328571,0.842553,
        0.980324,0.327975,0.846378,
        0.979257,0.327355,0.850183,
        0.978125,0.326712,0.853965,
        0.976922,0.326043,0.857721,
        0.975642,0.325346,0.861446,
        0.974295,0.324625,0.865143,
        0.972880,0.323880,0.868809,
        0.971398,0.323111,0.872444,
        0.969850,0.322318,0.876046,
        0.968237,0.321503,0.879614,
        0.966559,0.320664,0.883147,
        0.964830,0.319810,0.886614,
        0.963025,0.318927,0.890073,
        0.961166,0.318025,0.893498,
        0.959254,0.317106,0.896889,
        0.957295,0.316169,0.900248,
        0.955292,0.315218,0.903578,
        0.953250,0.314253,0.906879,
        0.951172,0.313276,0.910154,
        0.949058,0.312287,0.913402,
        0.946902,0.311283,0.916618,
        0.944695,0.310262,0.919794,
        0.942435,0.309223,0.922927,
        0.940115,0.308165,0.926009,
        0.937731,0.307084,0.929033,
        0.935275,0.305980,0.931991,
        0.932743,0.304851,0.934874,
        0.930130,0.303696,0.937674,
        0.927433,0.302514,0.940380,
        0.924649,0.301304,0.942985,
        0.921778,0.300067,0.945480,
        0.918811,0.298800,0.947846,
        0.915769,0.297511,0.950100,
        0.912658,0.296202,0.952247,
        0.909487,0.294875,0.954291,
        0.906262,0.293533,0.956240,
        0.902989,0.292177,0.958097,
        0.899673,0.290810,0.959868,
        0.896320,0.289433,0.961559,
        0.892930,0.288047,0.963168,
        0.889509,0.286653,0.964701,
        0.886062,0.285253,0.966169,
        0.882592,0.283847,0.967577,
        0.879101,0.282436,0.968927,
        0.875590,0.281021,0.970221,
        0.872062,0.279603,0.971461,
        0.868514,0.278180,0.972640,
        0.864951,0.276754,0.973768,
        0.861375,0.275326,0.974849,
        0.857786,0.273895,0.975885,
        0.854186,0.272463,0.976878,
        0.850575,0.271028,0.977830,
        0.846953,0.269592,0.978735,
        0.843322,0.268155,0.979600,
        0.839683,0.266717,0.980429,
        0.836036,0.265278,0.981223,
        0.832382,0.263838,0.981983,
        0.828722,0.262397,0.982710,
        0.825055,0.260956,0.983397,
        0.821382,0.259514,0.984052,
        0.817704,0.258072,0.984678,
        0.814021,0.256630,0.985276,
        0.810334,0.255188,0.985847,
        0.806642,0.253745,0.986389,
        0.802947,0.252303,0.986902,
        0.799248,0.250861,0.987391,
        0.795547,0.249419,0.987858,
        0.791842,0.247977,0.988304,
        0.788136,0.246535,0.988730,
        0.784426,0.245094,0.989134,
        0.780715,0.243652,0.989519,
        0.777002,0.242211,0.989888,
        0.773287,0.240771,0.990241,
        0.769571,0.239330,0.990579,
        0.765853,0.237890,0.990903,
        0.762191,0.236472,0.991206,
        0.758470,0.235032,0.991500,
        0.754749,0.233593,0.991783,
        0.751027,0.232154,0.992054,
        0.747303,0.230715,0.992314,
        0.743579,0.229277,0.992564,
        0.739855,0.227838,0.992803,
        0.736129,0.226400,0.993031,
        0.732403,0.224963,0.993250,
        0.728676,0.223525,0.993460,
        0.724948,0.222088,0.993662,
        0.721221,0.220651,0.993856,
        0.717492,0.219214,0.994043,
        0.713763,0.217778,0.994222,
        0.710034,0.216342,0.994393,
        0.706304,0.214906,0.994557,
        0.702574,0.213470,0.994716,
        0.698844,0.212034,0.994868,
        0.695113,0.210599,0.995014,
        0.691382,0.209164,0.995155,
        0.687651,0.207729,0.995291,
        0.683919,0.206294,0.995422,
        0.680187,0.204859,0.995547,
        0.676455,0.203425,0.995668,
        0.672723,0.201990,0.995785,
        0.668991,0.200556,0.995898,
        0.665258,0.199122,0.996007,
        0.661526,0.197688,0.996112,
        0.657793,0.196255,0.996214,
        0.654060,0.194821,0.996312,
        0.650327,0.193388,0.996407,
        0.646593,0.191954,0.996500,
        0.642860,0.190521,0.996589,
        0.639127,0.189088,0.996676,
        0.635393,0.187655,0.996760,
        0.631659,0.186222,0.996841,
        0.627926,0.184789,0.996920,
        0.624192,0.183357,0.996997,
        0.620458,0.181924,0.997071,
        0.616724,0.180492,0.997143,
        0.612990,0.179059,0.997213,
        0.609256,0.177627,0.997280,
        0.605521,0.176195,0.997345,
        0.601787,0.174763,0.997408,
        0.598053,0.173331,0.997469,
        0.594318,0.171899,0.997527,
        0.590584,0.170467,0.997584,
        0.586849,0.169035,0.997638,
        0.583115,0.167603,0.997691,
        0.579380,0.166172,0.997742,
        0.575645,0.164740,0.997791,
        0.571910,0.163309,0.997838,
        0.568175,0.161878,0.997883,
        0.564440,0.160446,0.997927,
        0.560706,0.159015,0.997969,
        0.556971,0.157584,0.998009,
        0.553235,0.156153,0.998048,
        0.549500,0.154722,0.998086,
        0.545765,0.153291,0.998122,
        0.542030,0.151860,0.998158,
        0.538295,0.150429,0.998191,
        0.534560,0.148999,0.998224,
        0.530825,0.147568,0.998256,
        0.527089,0.146137,0.998287,
        0.523354,0.144706,0.998317,
        0.519619,0.143276,0.998346,
        0.515883,0.141845,0.998375,
        0.512148,0.140415,0.998402,
        0.508413,0.138984,0.998429,
        0.504677,0.137554,0.998455,
        0.500942,0.136123,0.998481,
        0.497206,0.134693,0.998506,
        0.493471,0.133263,0.998530,
        0.489736,0.131832,0.998554,
        0.486000,0.130402,0.998577,
        0.482265,0.128971,0.998600,
        0.478529,0.127541,0.998622,
        0.474794,0.126111,0.998644,
        0.471058,0.124681,0.998666,
        0.467323,0.123250,0.998687,
        0.463587,0.121820,0.998707,
        0.459852,0.120390,0.998727,
        0.456116,0.118960,0.998747,
        0.452381,0.117530,0.998767,
        0.448645,0.116100,0.998786,
        0.444910,0.114669,0.998805,
        0.441174,0.113239,0.998823,
        0.437438,0.111809,0.998841,
        0.433703,0.110379,0.998859,
        0.429967,0.108949,0.998876,
        0.426232,0.107519,0.998893,
        0.422496,0.106089,0.998910,
        0.418760,0.104659,0.998926,
        0.415025,0.103229,0.998942,
        0.411289,0.101799,0.998957,
        0.407554,0.100369,0.998972,
        0.403818,0.098939,0.998987,
        0.400082,0.097509,0.999002,
        0.396347,0.096079,0.999016,
        0.392611,0.094649,0.999030,
        0.388875,0.093219,0.999043,
        0.385140,0.091790,0.999056,
        0.381404,0.090360,0.999069,
        0.377668,0.088930,0.999082,
        0.373932,0.087500,0.999094,
        0.370197,0.086070,0.999106,
        0.366461,0.084640,0.999118,
        0.362725,0.083211,0.999129,
        0.358990,0.081781,0.999140,
        0.355254,0.080351,0.999151,
        0.351518,0.078921,0.999162,
        0.347782,0.077492,0.999172,
        0.344047,0.076062,0.999182,
        0.340311,0.074632,0.999192,
        0.336575,0.073203,0.999201,
        0.332839,0.071773,0.999211,
        0.329104,0.070343,0.999220,
        0.325368,0.068914,0.999229,
        0.321632,0.067484,0.999238,
        0.317896,0.066054,0.999246,
        0.314161,0.064625,0.999255,
        0.310425,0.063195,0.999263,
        0.306689,0.061765,0.999271,
        0.302953,0.060336,0.999279,
        0.299217,0.058906,0.999287,
        0.295482,0.057477,0.999294,
        0.291746,0.056047,0.999302,
        0.288010,0.054617,0.999309,
        0.284274,0.053188,0.999316,
        0.280538,0.051758,0.999323,
        0.276803,0.050329,0.999330,
        0.273067,0.048899,0.999337,
        0.269331,0.047470,0.999343,
        0.265595,0.046040,0.999350,
        0.261859,0.044610,0.999356,
        0.258123,0.043181,0.999362,
        0.254388,0.041751,0.999369,
        0.250652,0.040322,0.999375,
        0.246916,0.038892,0.999381,
        0.243180,0.037463,0.999386,
        0.239444,0.036033,0.999392,
        0.235708,0.034604,0.999398,
        0.231973,0.033174,0.999404,
        0.228237,0.031745,0.999409,
        0.224501,0.030315,0.999415,
        0.220765,0.028886,0.999420,
        0.217029,0.027456,0.999425,
        0.213293,0.026027,0.999430,
        0.209558,0.024597,0.999435,
        0.205822,0.023168,0.999440
    ];

    // Create the data texture
    const width = lookupTable.length/3;
    const data = new Float32Array(width*4);
    for (let i = 0; i < width; i++) {

        data[4*i] = lookupTable[3*i] * 1;
        data[4*i+1] = lookupTable[3*i+1] * 1;
        data[4*i+2] = lookupTable[3*i+2] * 1;
        data[4*i+3] = 1;
    }

    const texture = new THREE.DataTexture(data, width, 1, THREE.RGBAFormat, THREE.FloatType);
    texture.magFilter = THREE.LinearFilter; // this allows linear interpolation
    texture.needsUpdate = true;

    // Get shaders
    const colorShader = await loadShader('shaders/colors.glsl');
    const randomShader = await loadShader('shaders/random.glsl');
    const placementShader = await loadShader('shaders/complementCloud/placement.glsl');
    const vertexShader = await loadShader('shaders/complementCloud/vertex.glsl');
    const fragmentShader = await loadShader('shaders/complementCloud/fragment.glsl');

    // Create material
    const colorSpaceMaterial = new THREE.ShaderMaterial({
        vertexShader: colorShader + randomShader + placementShader + vertexShader,
        fragmentShader: colorShader + fragmentShader,
        uniforms: {
            spectrumLookup: {value: texture},
            ideal: {
                type: "3f",
                value: new THREE.Vector3(0., 0., 0.)
            },
            time: { value: .0 },
            mode: {value: 0}
        }
    });

    // Create points in cloud
    // XXXXX this needs to be fixed, these should use the actual spectrum positions if anything and not the complement spectrum as that one is longer 
    const positions = [...lookupTable];

    const cubes = 1;
    const size = 40;
    const cube_height = size * cubes;
    const cube_width = size;
    const cube_depth = size;

    for (let i = 0; i < cube_height; i += 1){
        for (let j = 0; j < cube_width; j += 1) {
            for (let k = 0; k < cube_depth; k += 1) {
                
                const x = size * Math.random() / (cube_height / cubes);
                const y = - size * Math.random() / (cube_width); // negative to make it easy to differentiate from spectral values in shader
                const z = size * Math.random() / (cube_depth);

                positions.push(x, y, z);
            }
        }
    }

    // Create cloud geometry
    const cloudGeometry = new THREE.BufferGeometry();
    cloudGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    cloudGeometry.computeBoundingSphere();

    // Display and place the object
    environment.object = new THREE.Points(cloudGeometry, colorSpaceMaterial);
    environment.scene.add(environment.object);
    environment.object.scale.set(0.33, 0.33, 0.33);
    environment.object.position.x = 0;
    environment.object.position.y = 0;
    environment.object.position.z = -1;
    
    // Select which points should be drawn
    environment.matchesDrawn = 0;    
    environment.drawCount = cube_height*cube_width*cube_depth * (Math.pow(environment.canvas.width/screen.width * 2 * screen.width/1920,2)) + 3200;
    environment.object.geometry.setDrawRange(3200, environment.drawCount );

    window.addEventListener('resize', () => {
        // note, there are 3603/3 points in the complement spectral band, and 9600/3 in the regular one
        environment.drawCount = cube_height*cube_width*cube_depth * (Math.pow(environment.canvas.width/screen.width * 2 * screen.width/1920,2)) + 3200;
        environment.object.geometry.setDrawRange(3200 - environment.matchesDrawn, environment.drawCount );
        //console.log(environment.matchesDrawn);
    });
        
}

async function addShaderOverlay(environment, uniforms, vertexFile, fragmentFile) {
    environment.composer = new EffectComposer(environment.renderer);
    environment.composer.addPass(new RenderPass(environment.scene, environment.camera));

    const shader = {
        uniforms: uniforms,
        vertexShader: await loadShader(vertexFile),
        fragmentShader: await loadShader(fragmentFile)
    };
    
    const pass = new ShaderPass(shader);
    environment.composer.addPass(pass);
}

async function loadVisualSpectrum(csvFile) {
    let threeJSData = [];

    // Await the asynchronous loading and processing of the CSV file
    const data = await d3.csv(csvFile);
    let modifiedData = data.slice(0, 3200); // 390.0 to 709.9
    modifiedData.forEach((row) => {
        threeJSData.push(parseFloat(row.X), parseFloat(row.Y), parseFloat(row.Z));
    });

    const spectrumWidth = threeJSData.length / 3;
    const spectralData = new Float32Array(spectrumWidth * 4);
    for (let i = 0; i < spectrumWidth; i++) {
        spectralData[4 * i] = threeJSData[3 * i] * 1;
        spectralData[4 * i + 1] = threeJSData[3 * i + 1] * 1;
        spectralData[4 * i + 2] = threeJSData[3 * i + 2] * 1;
        spectralData[4 * i + 3] = 1; // Alpha channel
    }

    // Create the data texture
    const visualSpectrum = new THREE.DataTexture(spectralData, spectrumWidth, 1, THREE.RGBAFormat, THREE.FloatType);
    visualSpectrum.magFilter = THREE.LinearFilter; // This allows linear interpolation
    visualSpectrum.needsUpdate = true;

    return visualSpectrum;
}


const XYZtoRGB1931 = new THREE.Matrix3().set(8041697/3400850, -3049000/3400850, -1591847/3400850,
    -1752003/3400850, 4851000/3400850, 301853/3400850,
    17697/3400850, -49000/3400850, 3432153/3400850);

function fillSpectrum(spectrum, cloudEnvironment) {

    cloudEnvironment.matchesDrawn = 9600/3;
    cloudEnvironment.object.geometry.attributes.position.needsUpdate = true;

    for (let i = 0; i < cloudEnvironment.matchesDrawn; i++) {
        cloudEnvironment.object.geometry.attributes.position.setXYZ(i,
            spectrum.image.data[4*i],
            spectrum.image.data[4*i+1],
            spectrum.image.data[4*i+2]);
    }

    cloudEnvironment.object.geometry.setDrawRange( 0, cloudEnvironment.drawCount );
}

function checkMatch(spectrum, matchEnvironment, cloudEnvironment) {
    
    const matchColor = matchEnvironment.composer.passes[1].uniforms.matchColor.value;
    const convertedMatchColor = matchColor.clone().applyMatrix3(XYZtoRGB1931).divideScalar(2.1230881684358494);
    const attemptColor = matchEnvironment.composer.passes[1].uniforms.sliderColor.value;

    if (convertedMatchColor.distanceTo(attemptColor) < 0.1) {

        cloudEnvironment.matchesDrawn += 1;

        var index = 3603/3 - cloudEnvironment.matchesDrawn;
        cloudEnvironment.object.geometry.attributes.position.needsUpdate = true;
        cloudEnvironment.object.geometry.attributes.position.setXYZ(index, matchColor.x, matchColor.y, matchColor.z);
        cloudEnvironment.object.geometry.setDrawRange( index, cloudEnvironment.drawCount );

        const proportion = Math.random();
        const i = 4*Math.round(proportion * (spectrum.image.data.length/4 - 1));

        matchColor.setX(spectrum.image.data[i]);
        matchColor.setY(spectrum.image.data[i+1]);
        matchColor.setZ(spectrum.image.data[i+2]);
    }

    //fillSpectrum(spectrum, cloudEnvironment);
}

function setUpMatching(spectrum, canvasName, matchingEnvironment, cloudEnvironment) {
    const canvas = document.getElementById(canvasName);

    canvas.addEventListener('mousemove', function(event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const proportion = x / canvas.width;
        const i = 4*Math.round(proportion * (spectrum.image.data.length/4 - 1));

        matchingEnvironment.composer.passes[1].uniforms.matchColor.value.setX(spectrum.image.data[i]);
        matchingEnvironment.composer.passes[1].uniforms.matchColor.value.setY(spectrum.image.data[i+1]);
        matchingEnvironment.composer.passes[1].uniforms.matchColor.value.setZ(spectrum.image.data[i+2]);
    });

    canvas.addEventListener('pointerup', function() {
        matchingEnvironment.matchColor.value.setX(matchingEnvironment.composer.passes[1].uniforms.matchColor.value.x);
        matchingEnvironment.matchColor.value.setY(matchingEnvironment.composer.passes[1].uniforms.matchColor.value.y);
        matchingEnvironment.matchColor.value.setZ(matchingEnvironment.composer.passes[1].uniforms.matchColor.value.z);
    });

    canvas.addEventListener('mouseleave', function() {
        matchingEnvironment.composer.passes[1].uniforms.matchColor.value.setX(matchingEnvironment.matchColor.value.x);
        matchingEnvironment.composer.passes[1].uniforms.matchColor.value.setY(matchingEnvironment.matchColor.value.y);
        matchingEnvironment.composer.passes[1].uniforms.matchColor.value.setZ(matchingEnvironment.matchColor.value.z);
    });

    document.getElementById('matchBtn').addEventListener('click', () =>
        checkMatch(spectrum, matchingEnvironment, cloudEnvironment));

}

async function initializeComplementCloud(environment, canvasName, divName) {
    initEnvironment(environment, document.getElementById(canvasName), document.getElementById(divName));
    await addObjects(environment);
    setupMotion(environment);
}

async function initializeColorMatching(environment, canvasName, divName) {
    initEnvironment(environment, document.getElementById(canvasName), document.getElementById(divName));
    await addShaderOverlay(environment, 
        {
            tDiffuse: { value: null }, // tDiffuse is the texture of the rendered scene
            time: { value: .0 },
            alpha: { value: 0.717955252861182 },
            gray: { value: 0.6260300163584603 },
            scale: {value: 2.1230881684358494},
            sliderColor: {
                type: "3f",
                value: new THREE.Vector3(0., 0., 0.)
            },
            matchColor: {
                type: "3f",
                value: new THREE.Vector3(0., 0., 0.)
            }
        },
        'shaders/colorMatching/vertex.glsl',
        'shaders/colorMatching/fragment.glsl');
    environment.matchColor = {
        type: "3f",
        value: new THREE.Vector3(0., 0., 0.)
    };
}

function drawAxis() {
    const containerWidth = document.getElementById('chart-container').clientWidth;
    const svgWidth = containerWidth;
    const svgHeight = 20;

    const svg = d3.select("#axis-svg");
    svg.attr('width', svgWidth)
       .attr('height', svgHeight);

    const scale = d3.scaleLinear()
                    .range([20, svgWidth - 20])
                    .domain([390, 710]);

    const axis = d3.axisBottom(scale);

    svg.selectAll("*").remove(); // Clear previous axis elements
    svg.append("g")
       .call(axis);
}

async function initializeVisualSpectrum(environment, canvasName, divName) {
    initEnvironment(environment, document.getElementById(canvasName), document.getElementById(divName));
    environment.spectrum = await loadVisualSpectrum(getPath('lin2012xyz2e_fine_7sf.csv'));

    await addShaderOverlay(environment, 
        {
            tDiffuse: { value: null }, // tDiffuse is the texture of the rendered scene
            time: { value: .0 },
            alpha: { value: 0.717955252861182 },
            gray: { value: 0.6260300163584603 },
            scale: {value: 2.1230881684358494},
            spectrum: {value: environment.spectrum}
        },
        getPath('shaders/visualSpectrum/vertex.glsl'),
        getPath('shaders/visualSpectrum/fragment.glsl'));

    drawAxis(); // Add axis
    window.addEventListener('resize', drawAxis); // Redraw the axis on window resize
}

async function initObjects() {

    await initializeComplementCloud(environments.complementCloud, 'complementCloud', 'complementCloudDiv');
    await initializeVisualSpectrum(environments.visualSpectrum, 'visualSpectrum', 'blank-chart');
    await initializeColorMatching(environments.colorMatching,'colorMatching','colorMatchingDiv');
    initializeSliders('#sliders', 0.717955252861182, 0.6260300163584603,
        environments.complementCloud.object.material.uniforms.ideal.value,
        environments.colorMatching.composer.passes[1].uniforms.sliderColor.value
        );
    setUpMatching(environments.visualSpectrum.composer.passes[1].uniforms.spectrum.value, 'visualSpectrum', environments.colorMatching, environments.complementCloud);

}

function animate(time) {
    requestAnimationFrame(animate);
    if (environments.complementCloud.object) {
        environments.complementCloud.object.material.uniforms.time.value = time;
    }
    if (environments.complementCloud.motionComponents.momentum) {environments.complementCloud.updateRotation();}
        
    // Render the scene
    environments.complementCloud.renderer.render(environments.complementCloud.scene, environments.complementCloud.camera);

    if (environments.colorMatching.composer) {
        environments.colorMatching.composer.passes[1].uniforms.time.value = time;
        environments.colorMatching.composer.render();
    }

    if (environments.visualSpectrum.composer) {
        environments.visualSpectrum.composer.passes[1].uniforms.time.value = time;
        environments.visualSpectrum.composer.render();
    }
}

function renderSlide(slideIndex) {
    // Update slide content and visibility based on `slideIndex`.
    // Use Three.js to handle canvas rendering.

    // Start the rendering loop
    animate();
}

function createSlideContent(slide) {
    // Create and return slide HTML content based on the slide data.
}

function setupNavigation() {
    // Setup event listeners for your navigation buttons.

    document.getElementById('next').addEventListener('click', () => {
        environments.complementCloud.object.material.uniforms.mode.value += 1;
        if (environments.complementCloud.object.material.uniforms.mode.value == 1) {
            fillSpectrum(environments.visualSpectrum.composer.passes[1].uniforms.spectrum.value, environments.complementCloud);
        }
    });

    document.getElementById('prev').addEventListener('click', () => {
        environments.complementCloud.object.material.uniforms.mode.value -= 1;});
}

document.addEventListener("DOMContentLoaded", function() {
    initObjects().catch(error => console.error(error));
    renderSlide(currentSlide);
    setupNavigation();
});